{% extends 'base.html' %}
{% load static %}

{% block title %}聊天 | 教育平台{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/chat.css' %}">
<style>
    /* 基本布局 */
    .chat-sidebar {
        height: calc(100vh - 200px);
        overflow-y: auto;
        overflow-x: hidden;
        border-right: 1px solid #e5e5e5;
        transition: all 0.3s ease;
    }
    .chat-container {
        height: calc(100vh - 200px);
        display: flex;
        flex-direction: column;
    }
    
    /* 消息列表区域 */
    .message-list {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 1rem;
    }
    
    /* 消息项 */
    .message-item {
        margin-bottom: 1rem;
        max-width: 75%;
        display: flex;
        flex-direction: column;
        animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .message-item.sent {
        margin-left: auto;
        align-items: flex-end;
    }
    .message-item.received {
        align-items: flex-start;
    }
    
    /* 消息内容 */
    .message-content {
        display: flex;
        flex-direction: column;
        max-width: 100%;
    }
    .message-bubble {
        padding: 0.75rem 1rem;
        border-radius: 1rem;
        display: inline-block;
        word-break: break-word;
        width: fit-content;
        max-width: 100%;
        box-sizing: border-box;
        white-space: pre-wrap;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        overflow-wrap: break-word;
        word-wrap: break-word;
        hyphens: auto;
    }
    .message-bubble a {
        word-break: break-all;
        display: inline-block;
        max-width: 100%;
    }
    .message-bubble.sent {
        background-color: var(--primary-color, #0d6efd);
        color: white;
        border-bottom-right-radius: 0;
    }
    .message-bubble.received {
        background-color: #f1f1f1;
        border-bottom-left-radius: 0;
    }
    .sender-name {
        font-size: 0.8rem;
        margin-bottom: 0.2rem;
        font-weight: 500;
    }
    .message-time {
        font-size: 0.7rem;
        opacity: 0.7;
        margin-top: 0.2rem;
    }
    
    /* 聊天输入区域 */
    .chat-input {
        padding: 1rem;
        background-color: #f8f9fa;
        border-top: 1px solid #dee2e6;
    }
    
    /* 聊天室状态 */
    .room-item.active {
        background-color: #e9ecef;
        border-left: 3px solid var(--primary-color, #0d6efd);
    }
    
    /* 欢迎界面 */
    .chat-welcome {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100%;
        text-align: center;
        padding: 2rem;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 10;
        background-color: #fff;
    }
    .chat-placeholder-icon {
        font-size: 4rem;
        color: #dee2e6;
        margin-bottom: 1rem;
    }
    
    /* 聊天列表项 */
    .chat-list-item {
        display: flex;
        padding: 12px 15px;
        border-bottom: 1px solid #f5f5f5;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.2s;
    }
    .chat-list-item:hover {
        background-color: #f8f9fa;
        transform: translateX(3px);
    }
    .chat-list-item.active {
        background-color: #e9ecef;
        border-left: 3px solid var(--primary-color, #0d6efd);
    }
    
    /* 聊天头像 */
    .chat-avatar {
        width: 48px;
        height: 48px;
        border-radius: 8px;
        margin-right: 12px;
        position: relative;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
        flex-shrink: 0;
    }
    .chat-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 8px;
        transition: transform 0.3s;
    }
    .chat-list-item:hover .chat-avatar img {
        transform: scale(1.05);
    }
    
    /* 聊天信息 */
    .chat-info {
        flex: 1;
        overflow: hidden;
        min-width: 0; /* 重要：防止 flex 子项溢出 */
    }
    .chat-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        width: 100%;
    }
    .chat-name, .chat-last-message {
        max-width: 100%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .chat-time {
        font-size: 0.8rem;
        color: #999;
        flex-shrink: 0;
        margin-left: 5px;
    }
    .chat-last-message {
        color: #999;
        font-size: 0.9rem;
    }
    
    /* 未读消息计数 */
    .unread-count {
        background-color: #f44336;
        color: white;
        border-radius: 50%;
        font-size: 0.7rem;
        min-width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: absolute;
        top: -5px;
        right: -5px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    /* 用户类型标签 */
    .user-type {
        font-size: 0.8rem;
        color: var(--primary-color, #0d6efd);
        margin-left: 5px;
    }
    
    /* 搜索框 */
    .chat-search {
        padding: 10px 15px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #e5e5e5;
    }
    .chat-search input {
        border-radius: 20px;
        padding-left: 30px;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23999' class='bi bi-search' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: 10px center;
        transition: all 0.3s ease;
    }
    
    /* 标签切换 */
    .chat-tabs {
        display: flex;
        border-bottom: 1px solid #e5e5e5;
    }
    .chat-tab {
        flex: 1;
        text-align: center;
        padding: 10px;
        cursor: pointer;
        color: #666;
        position: relative;
        transition: all 0.3s ease;
    }
    .chat-tab.active {
        color: var(--primary-color, #0d6efd);
        font-weight: 500;
    }
    .chat-tab.active:after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
        background-color: var(--primary-color, #0d6efd);
    }
    
    /* 系统消息 */
    .system-message {
        padding: 5px 10px;
        background-color: rgba(0,0,0,0.05);
        border-radius: 10px;
        margin: 10px auto;
        max-width: 80%;
        font-size: 0.8rem;
        color: #666;
    }
    
    /* 确保聊天列表容器没有水平溢出 */
    #unified-chat-list {
        width: 100%;
        overflow-x: hidden;
    }
    
    /* 模态框在移动端的样式修复 */
    .modal {
        z-index: 2000 !important;
    }
    
    .modal-backdrop {
        z-index: 1900 !important;
    }
    
    /* 响应式布局 */
    @media (max-width: 992px) {
        .message-item {
            max-width: 85%;
        }
        .chat-sidebar {
            height: calc(100vh - 180px);
        }
        .chat-container {
            height: calc(100vh - 180px);
        }
    }
    
    @media (max-width: 768px) {
        /* 移动端布局调整 - 为标题栏留出空间 */
        .container-fluid {
            padding-top: 50px; /* 为移动端标题栏留出空间 */
        }
        
        .chat-sidebar {
            height: calc(100vh - 120px);
            border: none;
            margin-top: 10px; /* 为内容添加一点顶部间距 */
        }
        
        /* 移动端的聊天室区域显示控制 */
        .mobile-chat-view .chat-main-card {
            position: fixed;
            top: 50px; /* 从标题栏下方开始 */
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1001;
            background-color: white;
            padding-top: 0;
            margin: 0;
            height: calc(100vh - 50px) !important; /* 减去标题栏高度 */
            border-radius: 0;
            box-shadow: none;
        }
        
        /* 移动端默认隐藏聊天区域 */
        .chat-area-container {
            display: none;
        }
        
        .mobile-chat-view .chat-area-container {
            display: block;
        }
        
        .mobile-chat-view .contact-list-container {
            display: none;
        }
        
        .contact-list-container {
            display: block;
        }
        
        /* 确保聊天输入区域在底部固定 */
        .chat-container {
            height: calc(100vh - 60px);
            padding-bottom: 70px; /* 为输入框腾出空间 */
        }
        
        /* 为移动端头部留出空间 - 修复之前的样式 */
        .mobile-chat-view .chat-container {
            padding-top: 0; /* 不需要额外的内边距，因为容器已经从标题栏下方开始 */
        }
        
        .chat-input {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            padding: 10px;
            box-sizing: border-box;
            height: 70px;
        }
        
        /* 修复消息列表高度，确保内容不被输入框遮挡 */
        .message-list {
            margin-bottom: 80px; /* 大于聊天输入框高度 */
            padding-bottom: 20px;
        }
        
        /* 微信风格标题栏 */
        .mobile-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background-color: #f8f9fa;
            z-index: 1002;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
        }
        
        .mobile-title {
            font-size: 1.1rem;
            font-weight: 500;
        }
        
        .mobile-back-btn {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        /* 模态框在移动端的样式增强 */
        .modal-dialog {
            margin: 1rem auto;
            max-width: 95%;
        }
    }
    
    @media (max-width: 576px) {
        .message-item {
            max-width: 95%;
        }
        .chat-welcome {
            padding: 1rem;
        }
        .create-group-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        .chat-list-item {
            padding: 10px;
        }
        .chat-avatar {
            width: 40px;
            height: 40px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4 animate__animated animate__fadeIn" id="chat-main-container">
    <!-- 移动端标题栏 -->
    <div class="mobile-header d-md-none">
        <button class="btn btn-sm btn-link mobile-back-btn d-none" id="mobile-back-btn">
            <i class="fas fa-arrow-left"></i>
        </button>
        <div class="mobile-title">聊天</div>
    </div>

    <div class="row d-md-flex d-none">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-comments me-2"></i>聊天中心</h2>
            </div>
        </div>
    </div>
    
    <div class="row" id="chat-container">
        <!-- 联系人列表容器 -->
        <div class="col-md-4 col-lg-3 mb-4 mb-md-0 contact-list-container">
            <div class="chat-sidebar card" id="chat-sidebar">
                <div class="d-flex justify-content-between align-items-center p-3">
                    <h5 class="mb-0 d-none d-md-block">聊天</h5>
                    <button class="btn btn-sm btn-primary create-group-btn" data-bs-toggle="modal" data-bs-target="#createGroupModal">
                        <i class="fas fa-users"></i> <span class="d-none d-sm-inline">新建群组</span>
                    </button>
                </div>
                
                <div class="chat-search">
                    <input type="text" class="form-control" id="chat-search-input" placeholder="搜索聊天和用户" autocomplete="off">
                </div>
                
                <div class="chat-tabs">
                    <div class="chat-tab active" id="tab-chats">聊天</div>
                    <div class="chat-tab" id="tab-contacts">联系人</div>
                </div>
                
                <!-- 统一的聊天列表 -->
                <div id="unified-chat-list">
                    <!-- 我的聊天部分 -->
                    {% for room in chat_rooms %}
                    <div class="chat-list-item room-item" data-room-id="{{ room.id }}" onclick="loadChatRoom({{ room.id }})">
                        <div class="chat-avatar">
                            {% if room.is_private and room.other_participant %}
                                {% if room.other_participant.profile_image %}
                                <img src="{{ room.other_participant.profile_image.url }}" alt="{{ room.name }}">
                                {% else %}
                                <img src="{% static 'images/default-avatar.png' %}" alt="{{ room.name }}">
                                {% endif %}
                            {% else %}
                                <img src="{% static 'images/group-avatar.png' %}" alt="{{ room.name }}">
                            {% endif %}
                            
                            {% if room.unread_count > 0 %}
                            <div class="unread-count unread-badge" data-room-id="{{ room.id }}">{{ room.unread_count }}</div>
                            {% endif %}
                        </div>
                        <div class="chat-info">
                            <div class="chat-header">
                                <h6 class="chat-name">{{ room.name }}</h6>
                                <span class="chat-time">
                                    {% if room.last_message_time %}
                                    {{ room.last_message_time|date:"m-d H:i" }}
                                    {% endif %}
                                </span>
                            </div>
                            <div class="chat-last-message">
                                {% if room.last_message %}
                                {{ room.last_message }}
                                {% else %}
                                无消息
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                    <!-- 可聊天的用户部分 -->
                    {% for user in available_users %}
                    <div class="chat-list-item contact-item" data-user-id="{{ user.id }}" onclick="startPrivateChat({{ user.id }})">
                        <div class="chat-avatar">
                            {% if user.profile_image %}
                            <img src="{{ user.profile_image.url }}" alt="{{ user.username }}">
                            {% else %}
                            <img src="{% static 'images/default-avatar.png' %}" alt="{{ user.username }}">
                            {% endif %}
                        </div>
                        <div class="chat-info">
                            <div class="chat-header">
                                <h6 class="chat-name">
                                    {{ user.username }}
                                    <span class="user-type">({{ user.get_role_display }})</span>
                                </h6>
                            </div>
                            <div class="chat-last-message">
                                上次活跃：{{ user.last_login|date:"Y-m-d H:i" }}
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                    <!-- 如果没有聊天和用户 -->
                    {% if not chat_rooms and not available_users %}
                    <div class="text-center p-4">
                        <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                        <p>暂无聊天和联系人</p>
                        <small class="text-muted">添加联系人开始聊天吧！</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- 右侧聊天内容区 -->
        <div class="col-md-8 col-lg-9 chat-area-container">
            <div class="card h-100 chat-main-card position-relative">
                <!-- 初始欢迎界面 -->
                <div id="chat-welcome" class="chat-welcome">
                    <div class="chat-placeholder-icon">
                        <i class="fas fa-comments"></i>
                    </div>
                    <h4>选择一个聊天或开始新对话</h4>
                    <p class="text-muted">从左侧选择一个聊天室或用户开始对话</p>
                </div>
                
                <!-- 聊天室界面 (初始隐藏) -->
                <div id="chat-room-container" class="d-none position-relative" style="z-index: 20;">
                    <div class="card-header d-flex justify-content-between align-items-center d-md-flex d-none">
                        <div class="d-flex align-items-center">
                            <div>
                                <h5 class="mb-0" id="room-name"></h5>
                                <small id="room-info" class="text-muted"></small>
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-sm btn-outline-secondary" id="close-chat-btn">
                                <i class="fas fa-times"></i> <span class="d-none d-sm-inline">关闭</span>
                            </button>
                        </div>
                    </div>
                    <div class="chat-container">
                        <div class="message-list" id="message-list">
                            <div class="text-center my-3" id="loading-indicator">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                                <p>加载消息中...</p>
                            </div>
                        </div>
                        <div class="chat-input">
                            <form id="chat-form" class="d-flex">
                                <input type="text" class="form-control" id="message-input" placeholder="输入消息..." autocomplete="off">
                                <button type="submit" class="btn btn-primary ms-2" id="send-button">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 创建群组模态框 -->
<div class="modal fade" id="createGroupModal" tabindex="-1" aria-labelledby="createGroupModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createGroupModalLabel">创建群组</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="group-name" class="form-label">群组名称</label>
                    <input type="text" class="form-control" id="group-name" required>
                </div>
                <div class="mb-3">
                    <label for="group-description" class="form-label">群组描述（可选）</label>
                    <textarea class="form-control" id="group-description" rows="3"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">添加成员</label>
                    <div class="user-selection" style="max-height: 200px; overflow-y: auto;">
                        {% for user in available_users %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="{{ user.id }}" id="user-{{ user.id }}">
                            <label class="form-check-label" for="user-{{ user.id }}">
                                {{ user.username }} ({{ user.get_role_display }})
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="create-group-btn">创建群组</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 全局变量
    const currentUserId = {{ request.user.id }};
    let activeRoomId = null;
    let chatSocket = null;
    let reconnectAttempts = 0;
    let isConnecting = false;
    const maxReconnectAttempts = 5;
    let reconnectInterval = 3000;
    let emptyStateElement = null;
    let isMobileView = window.innerWidth < 768;
    
    // DOM元素
    const messageList = document.getElementById('message-list');
    const messageInput = document.getElementById('message-input');
    const chatForm = document.getElementById('chat-form');
    const sendButton = document.getElementById('send-button');
    const loadingIndicator = document.getElementById('loading-indicator');
    const chatWelcome = document.getElementById('chat-welcome');
    const chatRoomContainer = document.getElementById('chat-room-container');
    const roomName = document.getElementById('room-name');
    const roomInfo = document.getElementById('room-info');
    const chatSidebar = document.getElementById('chat-sidebar');
    const chatContainer = document.getElementById('chat-container');
    const contactListContainer = document.querySelector('.contact-list-container');
    const chatAreaContainer = document.querySelector('.chat-area-container');
    const mobileBackBtn = document.getElementById('mobile-back-btn');
    const mobileTitle = document.querySelector('.mobile-title');
    const chatMainContainer = document.getElementById('chat-main-container');
    
    // 检测设备类型并设置视图模式
    function updateViewMode() {
        isMobileView = window.innerWidth < 768;
        
        if (isMobileView) {
            // 移动端视图
            chatMainContainer.classList.add('mobile-chat-view');
            
            // 如果有活跃聊天室，则显示返回按钮
            if (activeRoomId) {
                showChatArea();
            } else {
                showContactList();
            }
        } else {
            // 桌面端视图
            chatMainContainer.classList.remove('mobile-chat-view');
            contactListContainer.style.display = 'block';
            chatAreaContainer.style.display = 'block';
        }
    }
    
    // 显示联系人列表（移动端）
    function showContactList() {
        if (!isMobileView) return;
        
        contactListContainer.style.display = 'block';
        chatAreaContainer.style.display = 'none';
        chatMainContainer.classList.remove('mobile-chat-view');
        mobileBackBtn.classList.add('d-none');
        mobileTitle.textContent = '聊天';
    }
    
    // 显示聊天区域（移动端）
    function showChatArea() {
        if (!isMobileView) return;
        
        contactListContainer.style.display = 'none';
        chatAreaContainer.style.display = 'block';
        chatMainContainer.classList.add('mobile-chat-view');
        mobileBackBtn.classList.remove('d-none');
        
        // 更新聊天标题
        if (roomName.textContent) {
            mobileTitle.textContent = roomName.textContent;
        } else {
            mobileTitle.textContent = '聊天';
        }
    }
    
    // 初始设置视图模式
    updateViewMode();
    
    // 窗口大小改变时更新视图模式
    window.addEventListener('resize', updateViewMode);
    
    // 返回联系人列表
    mobileBackBtn.addEventListener('click', function() {
        if (chatSocket) {
            chatSocket.close(1000, "用户返回联系人列表");
        }
        
        activeRoomId = null;
        showContactList();
        
        // 移除活跃状态
        document.querySelectorAll('.room-item').forEach(item => {
            item.classList.remove('active');
        });
    });
    
    // 聊天标签切换
    document.getElementById('tab-chats').addEventListener('click', function() {
        this.classList.add('active');
        document.getElementById('tab-contacts').classList.remove('active');
        // 显示聊天列表，隐藏联系人列表
        document.querySelectorAll('.room-item').forEach(item => {
            item.style.display = 'flex';
        });
        document.querySelectorAll('.contact-item').forEach(item => {
            item.style.display = 'none';
        });
    });
    
    document.getElementById('tab-contacts').addEventListener('click', function() {
        this.classList.add('active');
        document.getElementById('tab-chats').classList.remove('active');
        // 显示联系人列表，隐藏聊天列表
        document.querySelectorAll('.room-item').forEach(item => {
            item.style.display = 'none';
        });
        document.querySelectorAll('.contact-item').forEach(item => {
            item.style.display = 'flex';
        });
    });
    
    // 搜索功能
    document.getElementById('chat-search-input').addEventListener('input', function() {
        const searchText = this.value.toLowerCase();
        
        // 筛选聊天和联系人
        const listItems = document.querySelectorAll('.chat-list-item');
        listItems.forEach(item => {
            const name = item.querySelector('.chat-name').textContent.toLowerCase();
            const isVisible = name.includes(searchText);
            
            if (isVisible) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    });
    
    // 加载聊天室
    function loadChatRoom(roomId) {
        // 如果点击的是当前活跃的聊天室，则不重新加载
        if (activeRoomId === roomId) return;
        
        // 关闭之前的WebSocket连接
        if (chatSocket) {
            chatSocket.close(1000, "切换聊天室");
        }
        
        // 更新活跃状态
        document.querySelectorAll('.room-item').forEach(item => {
            item.classList.remove('active');
        });
        const selectedRoom = document.querySelector(`.room-item[data-room-id="${roomId}"]`);
        if (selectedRoom) {
            selectedRoom.classList.add('active');
        }
        
        // 清除未读消息计数
        const unreadBadge = document.querySelector(`.unread-badge[data-room-id="${roomId}"]`);
        if (unreadBadge) {
            unreadBadge.remove();
        }
        
        // 显示聊天室，隐藏欢迎界面 - 强制隐藏欢迎界面
        chatWelcome.style.display = 'none';
        chatWelcome.style.visibility = 'hidden';
        chatWelcome.style.opacity = '0';
        chatWelcome.style.zIndex = '-1';
        
        // 确保聊天室界面显示
        chatRoomContainer.classList.remove('d-none');
        chatRoomContainer.style.display = 'block';
        chatRoomContainer.style.visibility = 'visible';
        chatRoomContainer.style.opacity = '1';
        chatRoomContainer.style.zIndex = '20';
        
        // 清空聊天记录
        messageList.innerHTML = '';
        
        // 显示加载指示器
        loadingIndicator.style.display = 'block';
        
        // 移动端视图切换
        if (isMobileView) {
            showChatArea();
        }
        
        // 获取聊天室信息
        fetch(`/chat/api/room/${roomId}/`)
            .then(response => response.json())
            .then(data => {
                roomName.textContent = data.room.name;
                
                if (data.room.is_private && data.chat_with) {
                    roomInfo.textContent = `私聊 - ${data.chat_with.username}`;
                } else {
                    roomInfo.textContent = `${data.room.participants_count} 位成员`;
                }
                
                // 设置活跃聊天室ID
                activeRoomId = roomId;
                
                // 连接WebSocket
                connectWebSocket(roomId);
                
                // 更新移动端标题
                if (isMobileView) {
                    mobileTitle.textContent = data.room.name;
                }
            })
            .catch(error => {
                console.error('获取聊天室信息失败:', error);
                messageList.innerHTML = `
                    <div class="alert alert-danger m-3">
                        <h5><i class="fas fa-exclamation-triangle"></i> 加载失败</h5>
                        <p>无法加载聊天室信息，请重试。</p>
                    </div>
                `;
                loadingIndicator.style.display = 'none';
            });
    }
    
    // 关闭聊天
    document.getElementById('close-chat-btn').addEventListener('click', function() {
        // 关闭WebSocket连接
        if (chatSocket) {
            chatSocket.close(1000, "用户关闭聊天");
        }
        
        // 重置活跃聊天室
        activeRoomId = null;
        
        // 移除活跃状态
        document.querySelectorAll('.room-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // 显示欢迎界面，隐藏聊天室
        chatWelcome.style.display = 'flex';
        chatWelcome.style.visibility = 'visible';
        chatWelcome.style.opacity = '1';
        chatWelcome.style.zIndex = '10';
        
        chatRoomContainer.classList.add('d-none');
        chatRoomContainer.style.display = 'none';
        chatRoomContainer.style.visibility = 'hidden';
        chatRoomContainer.style.zIndex = '-1';
        
        // 移动端返回联系人列表
        if (isMobileView) {
            showContactList();
        }
    });
    
    // 格式化日期
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString(undefined, {
            month: 'short', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
    
    // 创建消息元素
    function createMessageElement(message, senderId, senderName, timestamp, isRead) {
        const isSent = senderId === currentUserId;
        
        const messageItem = document.createElement('div');
        messageItem.classList.add('message-item');
        if (isSent) {
            messageItem.classList.add('sent');
        } else {
            messageItem.classList.add('received');
        }
        
        let html = '';
        
        // 发送者名称只在接收到的消息中显示
        if (!isSent) {
            html += `<div class="sender-name">${senderName}</div>`;
        }
        
        // 安全处理消息内容，防止XSS攻击
        const safeMessage = message
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;')
            // 将URL转换为链接
            .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer" class="text-break">$1</a>')
            // 将换行符转换为<br>
            .replace(/\n/g, '<br>');
            
        html += `<div class="message-content">`;
        html += `<div class="message-bubble ${isSent ? 'sent' : 'received'}">${safeMessage}</div>`;
        html += `<div class="message-time">${formatDate(timestamp)}</div>`;
        html += `</div>`;
        
        messageItem.innerHTML = html;
        return messageItem;
    }
    
    // 滚动到底部
    function scrollToBottom() {
        // 使用延时确保DOM更新后再滚动
        setTimeout(() => {
            messageList.scrollTop = messageList.scrollHeight;
        }, 50);
    }
    
    // 添加消息到列表
    function addMessage(message, senderId, senderName, timestamp, isRead) {
        // 如果存在"暂无消息"提示，则移除它
        if (emptyStateElement && emptyStateElement.parentNode) {
            emptyStateElement.remove();
            emptyStateElement = null;
        }
        
        const messageElement = createMessageElement(message, senderId, senderName, timestamp, isRead);
        messageList.appendChild(messageElement);
        
        // 确保在添加消息后立即滚动到底部
        scrollToBottom();
    }
    
    // 显示系统消息
    function showSystemMessage(message, type = 'info') {
        const systemMessage = document.createElement('div');
        systemMessage.classList.add('text-center', 'my-2', 'system-message');
        
        let icon = 'info-circle';
        let color = 'text-info';
        
        if (type === 'error') {
            icon = 'exclamation-triangle';
            color = 'text-danger';
        } else if (type === 'success') {
            icon = 'check-circle';
            color = 'text-success';
        }
        
        systemMessage.innerHTML = `
            <small class="${color}">
                <i class="fas fa-${icon} me-1"></i> ${message}
            </small>
        `;
        
        messageList.appendChild(systemMessage);
        scrollToBottom();
        
        // 5秒后自动移除
        setTimeout(() => {
            systemMessage.remove();
        }, 5000);
    }
    
    // 更新连接状态
    function updateConnectionStatus(status) {
        switch(status) {
            case 'connecting':
                sendButton.disabled = true;
                messageInput.disabled = true;
                break;
            case 'connected':
                sendButton.disabled = false;
                messageInput.disabled = false;
                break;
            case 'disconnected':
            case 'closed':
                sendButton.disabled = true;
                messageInput.disabled = true;
                break;
        }
    }
    
    // 连接WebSocket
    function connectWebSocket(roomId) {
        if (isConnecting || !roomId) {
            return;
        }
        
        isConnecting = true;
        updateConnectionStatus('connecting');
        
        // 如果已经超过最大重连次数，显示错误
        if (reconnectAttempts >= maxReconnectAttempts) {
            messageList.innerHTML = `
                <div class="alert alert-danger m-3">
                    <h5><i class="fas fa-exclamation-triangle"></i> 连接失败</h5>
                    <p>无法连接到聊天服务器，请重试。</p>
                    <button class="btn btn-primary" onclick="connectWebSocket(${roomId})">重新连接</button>
                </div>
            `;
            loadingIndicator.style.display = 'none';
            updateConnectionStatus('disconnected');
            isConnecting = false;
            reconnectAttempts = 0;
            return;
        }
        
        const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const host = window.location.host;
        const wsUrl = `${protocol}${host}/ws/chat/${roomId}/`;
        
        try {
            // 关闭任何现有的WebSocket连接
            if (chatSocket) {
                try {
                    chatSocket.close(1000, "重新连接");
                } catch (e) {
                    // 忽略关闭错误
                }
            }
            
            chatSocket = new WebSocket(wsUrl);
            
            // 设置连接超时
            const connectionTimeout = setTimeout(() => {
                if (chatSocket && chatSocket.readyState !== WebSocket.OPEN) {
                    chatSocket.close(4000, "连接超时");
                }
            }, 10000); // 10秒连接超时
            
            chatSocket.onopen = function(e) {
                clearTimeout(connectionTimeout);
                reconnectAttempts = 0; // 重置重连次数
                reconnectInterval = 3000; // 重置重连间隔
                updateConnectionStatus('connected');
                isConnecting = false;
            };
            
            chatSocket.onclose = function(e) {
                updateConnectionStatus('disconnected');
                isConnecting = false;
                
                // 如果是正常关闭或页面刷新，不自动重连
                if (e.code === 1000 || e.code === 1001 || !activeRoomId || activeRoomId !== roomId) {
                    return;
                }
                
                // 非正常关闭时尝试重连
                reconnectAttempts++;
                
                // 使用指数退避策略增加重连间隔
                reconnectInterval = Math.min(reconnectInterval * 1.5, 30000);
                
                showSystemMessage(`连接已断开，${reconnectInterval/1000}秒后重试...`, 'error');
                
                setTimeout(function() {
                    if (activeRoomId === roomId) {
                        connectWebSocket(roomId);
                    }
                }, reconnectInterval);
            };
            
            chatSocket.onerror = function(e) {
                isConnecting = false;
                // WebSocket 错误事件不提供具体错误信息
            };
            
            chatSocket.onmessage = function(e) {
                try {
                    const data = JSON.parse(e.data);
                    
                    if (data.type === 'chat_history') {
                        // 清除加载指示器
                        loadingIndicator.style.display = 'none';
                        
                        if (data.messages.length === 0) {
                            emptyStateElement = document.createElement('div');
                            emptyStateElement.classList.add('text-center', 'my-5');
                            emptyStateElement.innerHTML = `
                                <div class="mb-3">
                                    <i class="fas fa-comments fa-3x text-muted"></i>
                                </div>
                                <h5>暂无消息</h5>
                                <p class="text-muted">发送第一条消息开始对话吧！</p>
                            `;
                            messageList.appendChild(emptyStateElement);
                        } else {
                            data.messages.forEach(function(msg) {
                                addMessage(msg.message, msg.sender_id, msg.sender_name, msg.timestamp, msg.is_read);
                            });
                            
                            // 确保在所有消息加载后滚动到底部
                            scrollToBottom();
                        }
                        
                        // 发送已读标记
                        if (chatSocket.readyState === WebSocket.OPEN) {
                            chatSocket.send(JSON.stringify({
                                'type': 'mark_read'
                            }));
                        }
                        
                    } else if (data.type === 'chat_message') {
                        addMessage(data.message, data.sender_id, data.sender_name, data.timestamp, false);
                        
                        // 如果消息不是自己发送的，则标记为已读
                        if (data.sender_id !== currentUserId && chatSocket.readyState === WebSocket.OPEN) {
                            chatSocket.send(JSON.stringify({
                                'type': 'mark_read'
                            }));
                        }
                    }
                } catch (error) {
                    showSystemMessage('处理消息时出错', 'error');
                }
            };
        } catch(error) {
            updateConnectionStatus('disconnected');
            isConnecting = false;
            reconnectAttempts++;
            showSystemMessage(`连接出错，${reconnectInterval/1000}秒后重试...`, 'error');
            
            setTimeout(function() {
                if (activeRoomId === roomId) {
                    connectWebSocket(roomId);
                }
            }, reconnectInterval);
        }
    }
    
    // 发送消息
    function sendMessage(message) {
        if (!message.trim() || !activeRoomId) return;
        
        if (!chatSocket || chatSocket.readyState !== WebSocket.OPEN) {
            showSystemMessage('无法发送消息，正在尝试重新连接...', 'error');
            connectWebSocket(activeRoomId);
            return;
        }
        
        try {
            chatSocket.send(JSON.stringify({
                'type': 'chat_message',
                'message': message
            }));
            
            messageInput.value = '';
        } catch (error) {
            showSystemMessage('发送消息失败，请重试', 'error');
        }
    }
    
    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 提交表单发送消息
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            sendMessage(messageInput.value);
        });
        
        // 按Enter键发送消息
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage(messageInput.value);
            }
        });
        
        // 创建群组按钮点击事件
        document.getElementById('create-group-btn').addEventListener('click', function() {
            const groupName = document.getElementById('group-name').value.trim();
            const groupDescription = document.getElementById('group-description').value.trim();
            
            if (!groupName) {
                alert('请输入群组名称');
                return;
            }
            
            // 获取选中的用户
            const selectedUsers = [];
            document.querySelectorAll('.user-selection input:checked').forEach(function(checkbox) {
                selectedUsers.push(checkbox.value);
            });
            
            // 获取CSRF令牌
            const csrfToken = '{{ csrf_token }}';
            
            // 禁用按钮并显示加载状态
            const createGroupBtn = document.getElementById('create-group-btn');
            createGroupBtn.disabled = true;
            createGroupBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 创建中...';
            
            // 准备请求数据
            const requestData = {
                name: groupName,
                description: groupDescription,
                participants: selectedUsers
            };
            
            // 发送请求创建群组
            fetch('{% url "chat:create_group_chat" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(requestData),
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP错误 ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createGroupModal'));
                    modal.hide();
                    
                    // 刷新页面加载新群组
                    window.location.reload();
                } else {
                    throw new Error(data.message || '创建群组失败');
                }
            })
            .catch(error => {
                console.error('创建群组出错:', error);
                createGroupBtn.disabled = false;
                createGroupBtn.innerHTML = '创建群组';
                alert('创建群组失败: ' + error.message);
            });
        });
        
        // 在移动设备上初始化
        if (isMobileView) {
            // 默认显示聊天列表标签内容
            document.getElementById('tab-chats').click();
            // 确保显示联系人列表，隐藏聊天面板
            showContactList();
        }
    });
    
    // 添加开始私聊的函数
    function startPrivateChat(userId) {
        // 禁用点击区域，防止重复点击
        const contactItem = document.querySelector(`.contact-item[data-user-id="${userId}"]`);
        if (contactItem) {
            contactItem.style.pointerEvents = 'none';
            contactItem.style.opacity = '0.7';
        }
        
        // 获取CSRF令牌
        const csrfToken = '{{ csrf_token }}';
        
        // 准备请求数据
        const requestData = {
            user_id: userId
        };
        
        // 发送请求创建私聊
        fetch('{% url "chat:create_private_chat" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(requestData),
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP错误 ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                const roomId = data.room_id;
                
                // 恢复点击区域
                if (contactItem) {
                    contactItem.style.pointerEvents = '';
                    contactItem.style.opacity = '';
                }
                
                // 加载聊天室
                loadChatRoom(roomId);
                
                // 如果聊天室不在列表中，则刷新页面
                if (!document.querySelector(`.room-item[data-room-id="${roomId}"]`)) {
                    window.location.reload();
                }
            } else {
                throw new Error(data.message || '创建聊天失败');
            }
        })
        .catch(error => {
            console.error('创建私聊出错:', error);
            if (contactItem) {
                contactItem.style.pointerEvents = '';
                contactItem.style.opacity = '';
            }
            alert('创建聊天失败: ' + error.message);
        });
    }
    
    // 页面聚焦时标记消息为已读
    window.addEventListener('focus', function() {
        if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({
                'type': 'mark_read'
            }));
        }
    });
    
    // 页面离开前关闭WebSocket连接
    window.addEventListener('beforeunload', function() {
        if (chatSocket) {
            chatSocket.close(1000, '用户离开页面');
        }
    });
</script>
{% endblock %} 