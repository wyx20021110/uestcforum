{% extends 'base.html' %}
{% load static %}

{% block title %}聊天 | 教育平台{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/chat.css' %}">
<style>
    /* 基本布局 */
    .chat-sidebar {
        height: calc(100vh - 200px);
        overflow-y: auto;
        overflow-x: hidden;
        border-right: 1px solid #e5e5e5;
        transition: all 0.3s ease;
    }
    .chat-container {
        height: calc(100vh - 200px);
        display: flex;
        flex-direction: column;
    }
    
    /* 消息列表区域 */
    .message-list {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 1rem;
        position: relative;
        -webkit-overflow-scrolling: touch; /* 改善iOS滚动体验 */
    }
    
    /* 消息项 */
    .message-item {
        margin-bottom: 1rem;
        max-width: 75%;
        display: flex;
        flex-direction: column;
        animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes fadeOut {
        from { opacity: 1; transform: translateY(0); }
        to { opacity: 0; transform: translateY(10px); }
    }
    
    @keyframes slideInRight {
        from { transform: translateX(100%); }
        to { transform: translateX(0); }
    }
    
    @keyframes slideOutRight {
        from { transform: translateX(0); }
        to { transform: translateX(100%); }
    }
    
    @keyframes slideInLeft {
        from { transform: translateX(-100%); }
        to { transform: translateX(0); }
    }
    
    @keyframes slideOutLeft {
        from { transform: translateX(0); }
        to { transform: translateX(-100%); }
    }
    
    @keyframes pulse {
        0% { opacity: 0.6; }
        50% { opacity: 1; }
        100% { opacity: 0.6; }
    }
    
    .message-item.sent {
        margin-left: auto;
        align-items: flex-end;
    }
    .message-item.received {
        align-items: flex-start;
    }
    
    /* 消息内容 */
    .message-content {
        display: flex;
        flex-direction: column;
        max-width: 100%;
    }
    .message-bubble {
        padding: 0.75rem 1rem;
        border-radius: 1rem;
        display: inline-block;
        word-break: break-word;
        width: fit-content;
        max-width: 100%;
        box-sizing: border-box;
        white-space: pre-wrap;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        overflow-wrap: break-word;
        word-wrap: break-word;
        hyphens: auto;
    }
    .message-bubble a {
        word-break: break-all;
        display: inline-block;
        max-width: 100%;
    }
    .message-bubble.sent {
        background-color: var(--primary-color, #0d6efd);
        color: white;
        border-bottom-right-radius: 0;
    }
    .message-bubble.received {
        background-color: #f1f1f1;
        border-bottom-left-radius: 0;
    }
    .sender-name {
        font-size: 0.8rem;
        margin-bottom: 0.2rem;
        font-weight: 500;
    }
    .message-time {
        font-size: 0.7rem;
        opacity: 0.7;
        margin-top: 0.2rem;
    }
    
    /* 聊天输入区域 */
    .chat-input {
        padding: 1rem;
        background-color: #f8f9fa;
        border-top: 1px solid #dee2e6;
    }
    
    /* 聊天室状态 */
    .room-item.active {
        background-color: #e9ecef;
        border-left: 3px solid var(--primary-color, #0d6efd);
    }
    
    /* 欢迎界面 */
    .chat-welcome {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100%;
        text-align: center;
        padding: 2rem;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 10;
        background-color: #fff;
    }
    .chat-placeholder-icon {
        font-size: 4rem;
        color: #dee2e6;
        margin-bottom: 1rem;
    }
    
    /* 聊天列表项 */
    .chat-list-item {
        display: flex;
        padding: 12px 15px;
        border-bottom: 1px solid #f5f5f5;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.2s;
    }
    .chat-list-item:hover {
        background-color: #f8f9fa;
        transform: translateX(3px);
    }
    .chat-list-item.active {
        background-color: #e9ecef;
        border-left: 3px solid var(--primary-color, #0d6efd);
    }
    
    /* 聊天头像 */
    .chat-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        margin-right: 12px;
        position: relative;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
        flex-shrink: 0;
    }
    .chat-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
        transition: transform 0.3s;
    }
    .chat-list-item:hover .chat-avatar img {
        transform: scale(1.05);
    }
    
    /* 聊天信息 */
    .chat-info {
        flex: 1;
        overflow: hidden;
        min-width: 0; /* 重要：防止 flex 子项溢出 */
    }
    .chat-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        width: 100%;
    }
    .chat-name, .chat-last-message {
        max-width: 100%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .chat-time {
        font-size: 0.8rem;
        color: #999;
        flex-shrink: 0;
        margin-left: 5px;
    }
    .chat-last-message {
        color: #999;
        font-size: 0.9rem;
    }
    
    /* 未读消息计数 */
    .unread-count {
        background-color: #f44336;
        color: white;
        border-radius: 50%;
        font-size: 0.7rem;
        min-width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: absolute;
        top: -5px;
        right: -5px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    /* 用户类型标签 */
    .user-type {
        font-size: 0.8rem;
        color: var(--primary-color, #0d6efd);
        margin-left: 5px;
    }
    
    /* 搜索框 */
    .chat-search {
        padding: 10px 15px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #e5e5e5;
    }
    .chat-search input {
        border-radius: 20px;
        padding-left: 30px;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23999' class='bi bi-search' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: 10px center;
        transition: all 0.3s ease;
    }
    
    /* 标签切换 */
    .chat-tabs {
        display: flex;
        border-bottom: 1px solid #e5e5e5;
    }
    .chat-tab {
        flex: 1;
        text-align: center;
        padding: 10px;
        cursor: pointer;
        color: #666;
        position: relative;
        transition: all 0.3s ease;
    }
    .chat-tab.active {
        color: var(--primary-color, #0d6efd);
        font-weight: 500;
    }
    .chat-tab.active:after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
        background-color: var(--primary-color, #0d6efd);
    }
    
    /* 系统消息 */
    .system-message {
        padding: 5px 10px;
        background-color: rgba(0,0,0,0.05);
        border-radius: 10px;
        margin: 10px auto;
        max-width: 80%;
        font-size: 0.8rem;
        color: #666;
    }
    
    /* 确保聊天列表容器没有水平溢出 */
    #unified-chat-list {
        width: 100%;
        overflow-x: hidden;
    }
    
    /* 模态框在移动端的样式修复 */
    .modal {
        z-index: 2000 !important;
    }
    
    .modal-backdrop {
        z-index: 1900 !important;
    }
    
    /* 响应式布局 */
    @media (max-width: 992px) {
        .message-item {
            max-width: 85%;
        }
        .chat-sidebar {
            height: calc(100vh - 180px);
        }
        .chat-container {
            height: calc(100vh - 180px);
        }
    }
    
    @media (max-width: 768px) {
        #chat-main-container {
            padding-top: 60px;
        }
        
        .chat-sidebar {
            height: calc(100vh - 120px);
            border: none;
            margin-top: 10px;
            width: 100%;
            max-width: 100%;
            border-radius: 0;
            box-shadow: none;
            position: relative;
            top: 0;
            left: 0;
            right: 0;
            overflow-x: hidden;
        }
        
        .mobile-chat-view .chat-main-card {
            position: fixed;
            top: 50px;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1001;
            background-color: white;
            padding-top: 0;
            margin: 0;
            height: calc(100vh - 50px) !important;
            border-radius: 0;
            box-shadow: none;
        }
        
        .chat-area-container {
            display: none;
        }
        
        .mobile-chat-view .chat-area-container {
            display: block;
        }
        
        .mobile-chat-view .contact-list-container {
            display: none;
        }
        
        .contact-list-container {
            display: block;
            width: 100%;
        }
        
        .chat-input {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            padding: 10px;
            box-sizing: border-box;
            height: 70px;
        }
        
        .message-list {
            margin-bottom: 80px;
            padding-bottom: 20px;
        }
        .mobile-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background-color: #f8f9fa;
            z-index: 1002;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
        }
        .mobile-title {
            font-size: 1.1rem;
            font-weight: 500;
        }
        .mobile-back-btn {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
        }
        .modal-dialog {
            margin: 1rem auto;
            max-width: 95%;
        }
    }
    
    @media (max-width: 576px) {
        .message-item {
            max-width: 95%;
        }
        .chat-welcome {
            padding: 1rem;
        }
        .create-group-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        .chat-list-item {
            padding: 10px;
        }
        .chat-avatar {
            width: 40px;
            height: 40px;
        }
        
        /* 小屏幕上的容器处理 */
        #chat-main-container.container {
            padding-left: 0;
            padding-right: 0;
            max-width: 100%;
            width: 100%;
        }
        
        .chat-sidebar {
            border-radius: 0;
            margin: 0 auto;
            width: 100%;
            border: none;
            box-shadow: none;
        }
        
        #unified-chat-list {
            margin: 0 auto;
            width: 100%;
            padding: 0;
        }
        
        .chat-list-item {
            width: 100%;
            padding: 10px 15px;
            box-sizing: border-box;
        }
        
        .row.justify-content-center {
            margin-left: 0;
            margin-right: 0;
        }
        
        .contact-list-container {
            padding-left: 0;
            padding-right: 0;
        }
        
        .chat-main-card {
            margin: 0 auto;
            width: 100%;
        }
        .chat-area-container {
            display: none;
        }
        .mobile-chat-view .chat-area-container {
            display: block;
        }
    }
    
    /* 网络连接状态指示器 */
    .connection-status {
        position: fixed;
        bottom: 70px;
        left: 50%;
        transform: translateX(-50%);
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    .connection-status.show {
        opacity: 1;
    }
    
    .connection-status.connecting {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .connection-status.connected {
        background-color: #d4edda;
        color: #155724;
    }
    
    .connection-status.disconnected {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .connection-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .connection-status.connecting .connection-indicator {
        background-color: #ffc107;
        animation: pulse 1s infinite;
    }
    
    .connection-status.connected .connection-indicator {
        background-color: #28a745;
    }
    
    .connection-status.disconnected .connection-indicator {
        background-color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4 animate__animated animate__fadeIn" id="chat-main-container">
    <!-- 移动端标题栏 -->
    <div class="mobile-header d-md-none">
        <button class="btn btn-sm btn-link mobile-back-btn d-none" id="mobile-back-btn">
            <i class="fas fa-arrow-left"></i>
        </button>
        <div class="mobile-title">聊天</div>
    </div>

    <!-- 连接状态指示器 -->
    <div class="connection-status" id="connection-status">
        <div class="connection-indicator"></div>
        <span class="connection-text">连接中...</span>
    </div>

    <div class="row d-md-flex d-none">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-comments me-2"></i>聊天中心</h2>
            </div>
        </div>
    </div>
    
    <div class="row justify-content-center" id="chat-container">
        <!-- 联系人列表容器 -->
        <div class="col-md-4 col-lg-3 mb-4 mb-md-0 contact-list-container">
            <div class="chat-sidebar card" id="chat-sidebar">
                <div class="d-flex justify-content-between align-items-center p-3">
                    <h5 class="mb-0 d-none d-md-block">聊天</h5>
                </div>
                
                <div class="chat-search">
                    <input type="text" class="form-control" id="chat-search-input" placeholder="搜索聊天和用户" autocomplete="off">
                </div>
                
                <div class="chat-tabs">
                    <div class="chat-tab active" id="tab-chats">聊天</div>
                    <div class="chat-tab" id="tab-contacts">联系人</div>
                </div>
                
                <!-- 统一的聊天列表 -->
                <div id="unified-chat-list">
                    <!-- 我的聊天部分 -->
                    {% for room in chat_rooms %}
                    <div class="chat-list-item room-item" data-room-id="{{ room.id }}" onclick="loadChatRoom({{ room.id }})">
                        <div class="chat-avatar">
                            {% if room.is_private and room.other_participant %}
                                {% if room.other_participant.profile_image %}
                                <img src="{{ room.other_participant.profile_image.url }}" alt="{{ room.name }}">
                                {% else %}
                                <img src="https://ui-avatars.com/api/?name={{ room.other_participant.username }}&size=150&background=random" alt="{{ room.name }}" class="rounded-circle">
                                {% endif %}
                            {% else %}
                                <img src="https://ui-avatars.com/api/?name={{ room.name }}&size=150&background=3498db&color=fff" alt="{{ room.name }}" class="rounded-circle">
                            {% endif %}
                            
                            {% if room.unread_count > 0 %}
                            <div class="unread-count unread-badge" data-room-id="{{ room.id }}">{{ room.unread_count }}</div>
                            {% endif %}
                        </div>
                        <div class="chat-info">
                            <div class="chat-header">
                                <h6 class="chat-name">{{ room.name }}</h6>
                                <span class="chat-time">
                                    {% if room.last_message_time %}
                                    {{ room.last_message_time|date:"m-d H:i" }}
                                    {% endif %}
                                </span>
                            </div>
                            <div class="chat-last-message">
                                {% if room.last_message %}
                                {{ room.last_message }}
                                {% else %}
                                无消息
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                    <!-- 可聊天的用户部分 -->
                    {% for user in available_users %}
                    <div class="chat-list-item contact-item" data-user-id="{{ user.id }}" onclick="startPrivateChat({{ user.id }})">
                        <div class="chat-avatar">
                            {% if user.profile_image %}
                            <img src="{{ user.profile_image.url }}" alt="{{ user.username }}">
                            {% else %}
                            <img src="https://ui-avatars.com/api/?name={{ user.username }}&size=150&background=random" alt="{{ user.username }}" class="rounded-circle">
                            {% endif %}
                        </div>
                        <div class="chat-info">
                            <div class="chat-header">
                                <h6 class="chat-name">
                                    {{ user.username }}
                                    <span class="user-type">({{ user.get_role_display }})</span>
                                </h6>
                            </div>
                            <div class="chat-last-message">
                                上次活跃：{{ user.last_login|date:"Y-m-d H:i" }}
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                    <!-- 如果没有聊天和用户 -->
                    {% if not chat_rooms and not available_users %}
                    <div class="text-center p-4">
                        <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                        <p>暂无聊天和联系人</p>
                        <small class="text-muted">添加联系人开始聊天吧！</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- 右侧聊天内容区 -->
        <div class="col-md-8 col-lg-9 chat-area-container">
            <div class="card h-100 chat-main-card position-relative">
                <!-- 初始欢迎界面 -->
                <div id="chat-welcome" class="chat-welcome">
                    <div class="chat-placeholder-icon">
                        <i class="fas fa-comments"></i>
                    </div>
                    <h4>选择一个聊天或开始新对话</h4>
                    <p class="text-muted">从左侧选择一个聊天室或用户开始对话</p>
                </div>
                
                <!-- 聊天室界面 (初始隐藏) -->
                <div id="chat-room-container" class="d-none position-relative" style="z-index: 20;">
                    <div class="card-header d-flex justify-content-between align-items-center d-md-flex d-none">
                        <div class="d-flex align-items-center">
                            <div>
                                <h5 class="mb-0" id="room-name"></h5>
                                <small id="room-info" class="text-muted"></small>
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-sm btn-outline-secondary" id="close-chat-btn">
                                <i class="fas fa-times"></i> <span class="d-none d-sm-inline">关闭</span>
                            </button>
                        </div>
                    </div>
                    <div class="chat-container">
                        <div class="message-list" id="message-list">
                            <div class="text-center my-3" id="loading-indicator">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                                <p>加载消息中...</p>
                            </div>
                        </div>
                        <div class="chat-input">
                            <form id="chat-form" class="d-flex">
                                <input type="text" class="form-control" id="message-input" placeholder="输入消息..." autocomplete="off">
                                <button type="submit" class="btn btn-primary ms-2" id="send-button">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 全局变量
    const currentUserId = {{ request.user.id }};
    let activeRoomId = null;
    let chatSocket = null;
    let reconnectAttempts = 0;
    let isConnecting = false;
    const maxReconnectAttempts = 5;
    let reconnectInterval = 3000;
    let emptyStateElement = null;
    let isMobileView = window.innerWidth < 768;
    let touchStartX = 0;
    let touchEndX = 0;
    let isRefreshing = false;
    let pullStartY = 0;
    let pullMoveY = 0;
    let isPulling = false;
    let refreshIndicator = null;
    
    // DOM元素
    const messageList = document.getElementById('message-list');
    const messageInput = document.getElementById('message-input');
    const chatForm = document.getElementById('chat-form');
    const sendButton = document.getElementById('send-button');
    const loadingIndicator = document.getElementById('loading-indicator');
    const chatWelcome = document.getElementById('chat-welcome');
    const chatRoomContainer = document.getElementById('chat-room-container');
    const roomName = document.getElementById('room-name');
    const roomInfo = document.getElementById('room-info');
    const chatSidebar = document.getElementById('chat-sidebar');
    const chatContainer = document.getElementById('chat-container');
    const contactListContainer = document.querySelector('.contact-list-container');
    const chatAreaContainer = document.querySelector('.chat-area-container');
    const mobileBackBtn = document.getElementById('mobile-back-btn');
    const mobileTitle = document.querySelector('.mobile-title');
    const chatMainContainer = document.getElementById('chat-main-container');
    const connectionStatus = document.getElementById('connection-status');
    
    // 初始化下拉刷新指示器
    function initPullToRefresh() {
        if (!isMobileView) return;
        
        // 如果已经存在刷新指示器，先移除它
        if (refreshIndicator && refreshIndicator.parentNode) {
            refreshIndicator.parentNode.removeChild(refreshIndicator);
        }
        
        // 创建刷新指示器
        refreshIndicator = document.createElement('div');
        refreshIndicator.className = 'pull-to-refresh-indicator';
        refreshIndicator.innerHTML = `
            <div class="spinner-border text-primary spinner-border-sm" role="status">
                <span class="visually-hidden">刷新中...</span>
            </div>
            <span class="ms-2 refresh-text">下拉刷新</span>
        `;
        refreshIndicator.style.cssText = `
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 10px;
            background-color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            transform: translateY(-100%);
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            visibility: hidden; /* 初始状态下隐藏 */
        `;
        
        // 添加到DOM
        if (messageList && messageList.parentNode) {
            messageList.parentNode.insertBefore(refreshIndicator, messageList);
            
            // 确保初始状态下是完全隐藏的
            setTimeout(() => {
                if (refreshIndicator) {
                    refreshIndicator.style.transform = 'translateY(-100%)';
                    refreshIndicator.style.visibility = 'visible';
                }
            }, 100);
        }
    }
    
    // 设置触摸事件监听器
    function setupTouchEvents() {
        if (!isMobileView) return;
        
        // 滑动返回手势
        if (chatAreaContainer) {
            chatAreaContainer.addEventListener('touchstart', handleTouchStart, false);
            chatAreaContainer.addEventListener('touchmove', handleTouchMove, false);
            chatAreaContainer.addEventListener('touchend', handleTouchEnd, false);
        }
        
        // 下拉刷新手势
        if (messageList) {
            messageList.addEventListener('touchstart', handlePullStart, { passive: true });
            messageList.addEventListener('touchmove', handlePullMove, { passive: true });
            messageList.addEventListener('touchend', handlePullEnd, { passive: true });
        }
    }
    
    // 处理滑动返回触摸事件
    function handleTouchStart(e) {
        touchStartX = e.touches[0].clientX;
    }
    
    function handleTouchMove(e) {
        if (!activeRoomId) return;
        
        touchEndX = e.touches[0].clientX;
        const diffX = touchEndX - touchStartX;
        
        // 如果从左边缘向右滑动超过50px，添加视觉反馈
        if (touchStartX < 50 && diffX > 30) {
            chatAreaContainer.style.transform = `translateX(${Math.min(diffX, 100)}px)`;
            chatAreaContainer.style.transition = 'none';
            e.preventDefault();
        }
    }
    
    function handleTouchEnd(e) {
        if (!activeRoomId) return;
        
        const diffX = touchEndX - touchStartX;
        
        // 如果滑动距离足够大，返回联系人列表
        if (touchStartX < 50 && diffX > 100) {
            mobileBackBtn.click();
        }
        
        // 重置样式
        chatAreaContainer.style.transform = '';
        chatAreaContainer.style.transition = 'transform 0.3s ease';
    }
    
    // 处理下拉刷新触摸事件
    function handlePullStart(e) {
        if (isRefreshing || !messageList || messageList.scrollTop > 0) return;
        
        isPulling = true;
        pullStartY = e.touches[0].clientY;
        
        // 确保刷新指示器可见但初始位置在屏幕外
        if (refreshIndicator) {
            refreshIndicator.style.visibility = 'visible';
            refreshIndicator.style.transform = 'translateY(-100%)';
        }
    }
    
    function handlePullMove(e) {
        if (!isPulling || isRefreshing || !refreshIndicator) return;
        
        pullMoveY = e.touches[0].clientY;
        const pullDistance = pullMoveY - pullStartY;
        
        if (pullDistance > 0 && messageList.scrollTop <= 0) {
            // 更新指示器位置
            const translateY = Math.min(Math.max(pullDistance * 0.4, 0), 80);
            refreshIndicator.style.transform = `translateY(${translateY - 100}%)`;
            
            // 更新提示文本
            const refreshText = refreshIndicator.querySelector('.refresh-text');
            if (refreshText) {
                refreshText.textContent = pullDistance > 60 ? '释放刷新' : '下拉刷新';
            }
            
            // 阻止下拉导致的页面滚动
            e.preventDefault();
        }
    }
    
    function handlePullEnd(e) {
        if (!isPulling || isRefreshing) return;

        const pullDistance = pullMoveY - pullStartY;
        
        if (pullDistance > 60 && messageList.scrollTop <= 0) {
            // 执行刷新操作
            performRefresh();
        } else {
            // 复原指示器
            refreshIndicator.style.transform = 'translateY(-100%)';
        }
        
        isPulling = false;
    }
    
    // 完成刷新
    function finishRefresh() {
        // 复原指示器
        if (refreshIndicator) {
            refreshIndicator.style.transform = 'translateY(-100%)';
            // 确保完全隐藏
            setTimeout(() => {
                if (refreshIndicator) {
                    refreshIndicator.style.visibility = 'hidden';
                }
            }, 300); // 等待过渡动画完成
        }
        
        isRefreshing = false;
        
        // 显示刷新成功消息
        showSystemMessage('刷新成功', 'success');
    }
    
    // 检测设备类型并设置视图模式
    function updateViewMode() {
        isMobileView = window.innerWidth < 768;
        
        if (isMobileView) {
            // 移动端视图
            chatMainContainer.classList.add('mobile-chat-view');
            
            // 如果有活跃聊天室，则显示返回按钮
            if (activeRoomId) {
                showChatArea();
            } else {
                showContactList();
            }
            
            // 初始化移动端特定功能
            initPullToRefresh();
            setupTouchEvents();
        } else {
            // 桌面端视图
            chatMainContainer.classList.remove('mobile-chat-view');
            contactListContainer.style.display = 'block';
            chatAreaContainer.style.display = 'block';
            
            // 确保聊天室内容可见（如果已选择聊天室）
            if (activeRoomId) {
                chatWelcome.style.display = 'none';
                chatWelcome.style.visibility = 'hidden';
                chatWelcome.style.opacity = '0';
                chatWelcome.style.zIndex = '-1';
                
                chatRoomContainer.classList.remove('d-none');
                chatRoomContainer.style.display = 'block';
                chatRoomContainer.style.visibility = 'visible';
                chatRoomContainer.style.opacity = '1';
                chatRoomContainer.style.zIndex = '20';
            }
        }
    }
    
    // 显示联系人列表（移动端）
    function showContactList() {
        if (!isMobileView) return;
        
        // 使用动画效果
        contactListContainer.style.display = 'block';
        contactListContainer.style.animation = 'fadeIn 0.3s forwards';
        
        if (chatAreaContainer) {
            chatAreaContainer.style.animation = 'fadeOut 0.3s forwards';
            setTimeout(() => {
                chatAreaContainer.style.display = 'none';
            }, 300);
        }
        
        chatMainContainer.classList.remove('mobile-chat-view');
        mobileBackBtn.classList.add('d-none');
        mobileTitle.textContent = '聊天';
    }
    
    // 显示聊天区域（移动端）
    function showChatArea() {
        if (!isMobileView) return;
        
        // 使用动画效果
        chatAreaContainer.style.display = 'block';
        chatAreaContainer.style.animation = 'fadeIn 0.3s forwards';
        
        contactListContainer.style.animation = 'fadeOut 0.3s forwards';
        setTimeout(() => {
            contactListContainer.style.display = 'none';
        }, 300);
        
        chatMainContainer.classList.add('mobile-chat-view');
        mobileBackBtn.classList.remove('d-none');
        
        // 更新聊天标题
        if (roomName.textContent) {
            mobileTitle.textContent = roomName.textContent;
        } else {
            mobileTitle.textContent = '聊天';
        }
        
        // 确保输入框获得焦点
        setTimeout(() => {
            messageInput.focus();
        }, 400);
    }
    
    // 初始设置视图模式
    updateViewMode();

    // 确保初始状态下聊天列表显示正确
    fixChatListDisplay();
    
    // 窗口大小改变时更新视图模式
    window.addEventListener('resize', function() {
        const wasMobileView = isMobileView;
        isMobileView = window.innerWidth < 768;
        
        // 如果视图模式发生变化（从移动端变为桌面端或相反）
        if (wasMobileView !== isMobileView) {
            // 更新视图模式
            updateViewMode();
            
            // 如果有活跃聊天室，确保它能正确显示
            if (activeRoomId) {
                // 移除并重新添加活跃状态
                document.querySelectorAll('.room-item').forEach(item => {
                    item.classList.remove('active');
                });
                const selectedRoom = document.querySelector(`.room-item[data-room-id="${activeRoomId}"]`);
                if (selectedRoom) {
                    selectedRoom.classList.add('active');
                }
                
                // 确保聊天室内容可见
                chatWelcome.style.display = 'none';
                chatWelcome.style.visibility = 'hidden';
                chatWelcome.style.opacity = '0';
                chatWelcome.style.zIndex = '-1';
                
                chatRoomContainer.classList.remove('d-none');
                chatRoomContainer.style.display = 'block';
                chatRoomContainer.style.visibility = 'visible';
                chatRoomContainer.style.opacity = '1';
                chatRoomContainer.style.zIndex = '20';
                
                // 在桌面模式下，确保两个容器都可见
                if (!isMobileView) {
                    contactListContainer.style.display = 'block';
                    chatAreaContainer.style.display = 'block';
                }
            }
        }
    });
    
    // 返回联系人列表
    mobileBackBtn.addEventListener('click', function() {
        if (chatSocket) {
            chatSocket.close(1000, "用户返回联系人列表");
        }
        
        activeRoomId = null;
        showContactList();
        
        // 移除活跃状态
        document.querySelectorAll('.room-item').forEach(item => {
            item.classList.remove('active');
        });
    });
    
    // 聊天标签切换
    document.getElementById('tab-chats').addEventListener('click', function() {
        this.classList.add('active');
        document.getElementById('tab-contacts').classList.remove('active');
        // 显示聊天列表，隐藏联系人列表
        document.querySelectorAll('.room-item').forEach(item => {
            item.style.display = 'flex';
        });
        document.querySelectorAll('.contact-item').forEach(item => {
            item.style.display = 'none';
        });
    });
    
    document.getElementById('tab-contacts').addEventListener('click', function() {
        this.classList.add('active');
        document.getElementById('tab-chats').classList.remove('active');
        // 显示联系人列表，隐藏聊天列表
        document.querySelectorAll('.room-item').forEach(item => {
            item.style.display = 'none';
        });
        document.querySelectorAll('.contact-item').forEach(item => {
            item.style.display = 'flex';
        });
    });
    
    // 搜索功能
    document.getElementById('chat-search-input').addEventListener('input', function() {
        const searchText = this.value.toLowerCase();
        
        // 筛选聊天和联系人
        const listItems = document.querySelectorAll('.chat-list-item');
        listItems.forEach(item => {
            const name = item.querySelector('.chat-name').textContent.toLowerCase();
            const isVisible = name.includes(searchText);
            
            if (isVisible) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    });
    
    // 加载聊天室
    function loadChatRoom(roomId) {
        // 如果点击的是当前活跃的聊天室，则不重新加载
        if (activeRoomId === roomId) return;
        
        // 关闭之前的WebSocket连接
        if (chatSocket) {
            chatSocket.close(1000, "切换聊天室");
        }
        
        // 更新活跃状态
        document.querySelectorAll('.room-item').forEach(item => {
            item.classList.remove('active');
        });
        const selectedRoom = document.querySelector(`.room-item[data-room-id="${roomId}"]`);
        if (selectedRoom) {
            selectedRoom.classList.add('active');
        }
        
        // 清除未读消息计数
        const unreadBadge = document.querySelector(`.unread-badge[data-room-id="${roomId}"]`);
        if (unreadBadge) {
            unreadBadge.remove();
        }
        
        // 显示聊天室，隐藏欢迎界面 - 强制隐藏欢迎界面
        chatWelcome.style.display = 'none';
        chatWelcome.style.visibility = 'hidden';
        chatWelcome.style.opacity = '0';
        chatWelcome.style.zIndex = '-1';
        
        // 确保聊天室界面显示
        chatRoomContainer.classList.remove('d-none');
        chatRoomContainer.style.display = 'block';
        chatRoomContainer.style.visibility = 'visible';
        chatRoomContainer.style.opacity = '1';
        chatRoomContainer.style.zIndex = '20';
        
        // 清空聊天记录
        messageList.innerHTML = '';
        
        // 显示加载指示器并添加加载动画
        loadingIndicator.innerHTML = `
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <p class="mt-2">加载消息中...</p>
            <div class="progress mt-2" style="height: 4px; width: 100px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
            </div>
        `;
        loadingIndicator.style.display = 'block';
        
        // 移动端视图切换
        if (isMobileView) {
            showChatArea();
        }
        
        // 添加骨架屏动画，提升用户感知
        addMessageSkeletons();
        
        // 获取聊天室信息
        fetch(`/chat/api/room/${roomId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`服务器响应错误: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                roomName.textContent = data.room.name;
                
                if (data.room.is_private && data.chat_with) {
                    roomInfo.textContent = `私聊 - ${data.chat_with.username}`;
                } else {
                    roomInfo.textContent = `${data.room.participants_count} 位成员`;
                }
                
                // 设置活跃聊天室ID
                activeRoomId = roomId;
                
                // 连接WebSocket
                connectWebSocket(roomId);
                
                // 更新移动端标题
                if (isMobileView) {
                    mobileTitle.textContent = data.room.name;
                }
                
                // 移除骨架屏
                setTimeout(() => {
                    removeMessageSkeletons();
                }, 300);
            })
            .catch(error => {
                console.error('获取聊天室信息失败:', error);
                messageList.innerHTML = `
                    <div class="alert alert-danger m-3">
                        <h5><i class="fas fa-exclamation-triangle"></i> 加载失败</h5>
                        <p>无法加载聊天室信息: ${error.message}</p>
                        <button class="btn btn-primary mt-2" onclick="loadChatRoom(${roomId})">
                            <i class="fas fa-sync-alt"></i> 重试
                        </button>
                    </div>
                `;
                loadingIndicator.style.display = 'none';
                
                // 移除骨架屏
                removeMessageSkeletons();
            });
    }
    
    // 添加消息骨架屏
    function addMessageSkeletons() {
        // 添加3个骨架消息
        for (let i = 0; i < 3; i++) {
            const isRight = i % 2 === 0;
            const skeleton = document.createElement('div');
            skeleton.className = `message-item skeleton-message ${isRight ? 'sent' : 'received'}`;
            skeleton.innerHTML = `
                <div class="message-content">
                    <div class="message-bubble ${isRight ? 'sent' : 'received'}" 
                         style="background-color: #f0f0f0; width: ${70 + Math.random() * 100}px; height: 30px; animation: pulse 1.5s infinite;">
                    </div>
                    <div class="message-time" style="width: 50px; height: 12px; background-color: #f0f0f0; margin-top: 5px; border-radius: 3px; animation: pulse 1.5s infinite;"></div>
                </div>
            `;
            messageList.appendChild(skeleton);
        }
    }
    
    // 移除消息骨架屏
    function removeMessageSkeletons() {
        document.querySelectorAll('.skeleton-message').forEach(skeleton => {
            skeleton.remove();
        });
    }
    
    // 关闭聊天
    document.getElementById('close-chat-btn').addEventListener('click', function() {
        // 关闭WebSocket连接
        if (chatSocket) {
            chatSocket.close(1000, "用户关闭聊天");
        }
        
        // 重置活跃聊天室
        activeRoomId = null;
        
        // 移除活跃状态
        document.querySelectorAll('.room-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // 显示欢迎界面，隐藏聊天室
        chatWelcome.style.display = 'flex';
        chatWelcome.style.visibility = 'visible';
        chatWelcome.style.opacity = '1';
        chatWelcome.style.zIndex = '10';
        
        chatRoomContainer.classList.add('d-none');
        chatRoomContainer.style.display = 'none';
        chatRoomContainer.style.visibility = 'hidden';
        chatRoomContainer.style.zIndex = '-1';
        
        // 移动端返回联系人列表
        if (isMobileView) {
            showContactList();
        }
    });
    
    // 格式化日期
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString(undefined, {
            month: 'short', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
    
    // 创建消息元素
    function createMessageElement(message, senderId, senderName, timestamp, isRead) {
        const isSent = senderId === currentUserId;
        
        const messageItem = document.createElement('div');
        messageItem.classList.add('message-item');
        if (isSent) {
            messageItem.classList.add('sent');
        } else {
            messageItem.classList.add('received');
        }
        
        let html = '';
        
        // 发送者名称只在接收到的消息中显示
        if (!isSent) {
            html += `<div class="sender-name">${senderName}</div>`;
        }
        
        // 安全处理消息内容，防止XSS攻击
        const safeMessage = message
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;')
            // 将URL转换为链接
            .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer" class="text-break">$1</a>')
            // 将换行符转换为<br>
            .replace(/\n/g, '<br>');
            
        html += `<div class="message-content">`;
        html += `<div class="message-bubble ${isSent ? 'sent' : 'received'}">${safeMessage}</div>`;
        html += `<div class="message-time">${formatDate(timestamp)}</div>`;
        html += `</div>`;
        
        messageItem.innerHTML = html;
        return messageItem;
    }
    
    // 滚动到底部
    function scrollToBottom() {
        // 使用延时确保DOM更新后再滚动
        setTimeout(() => {
            messageList.scrollTop = messageList.scrollHeight;
        }, 50);
    }
    
    // 添加消息到列表
    function addMessage(message, senderId, senderName, timestamp, isRead) {
        // 如果存在"暂无消息"提示，则移除它
        if (emptyStateElement && emptyStateElement.parentNode) {
            emptyStateElement.remove();
            emptyStateElement = null;
        }
        
        const messageElement = createMessageElement(message, senderId, senderName, timestamp, isRead);
        messageList.appendChild(messageElement);
        
        // 确保在添加消息后立即滚动到底部
        scrollToBottom();
    }
    
    // 显示系统消息
    function showSystemMessage(message, type = 'info') {
        const systemMessage = document.createElement('div');
        systemMessage.classList.add('text-center', 'my-2', 'system-message');
        
        let icon = 'info-circle';
        let color = 'text-info';
        
        if (type === 'error') {
            icon = 'exclamation-triangle';
            color = 'text-danger';
        } else if (type === 'success') {
            icon = 'check-circle';
            color = 'text-success';
        }
        
        systemMessage.innerHTML = `
            <small class="${color}">
                <i class="fas fa-${icon} me-1"></i> ${message}
            </small>
        `;
        
        messageList.appendChild(systemMessage);
        scrollToBottom();
        
        // 5秒后自动移除
        setTimeout(() => {
            systemMessage.remove();
        }, 5000);
    }
    
    // 更新连接状态UI
    function updateConnectionStatusUI(status) {
        // 移除所有状态类
        connectionStatus.classList.remove('connecting', 'connected', 'disconnected');
        
        // 只在连接中状态时显示提示
        if (status === 'connecting') {
            connectionStatus.classList.add(status);
            connectionStatus.classList.add('show');
            
            // 更新文本
            const statusText = connectionStatus.querySelector('.connection-text');
            statusText.textContent = '正在连接...';
        } else {
            // 连接成功或断开连接时，隐藏提示
            connectionStatus.classList.remove('show');
        }
    }
    
    // 更新连接状态
    function updateConnectionStatus(status) {
        switch(status) {
            case 'connecting':
                sendButton.disabled = true;
                messageInput.disabled = true;
                updateConnectionStatusUI('connecting');
                break;
            case 'connected':
                sendButton.disabled = false;
                messageInput.disabled = false;
                updateConnectionStatusUI('connected');
                break;
            case 'disconnected':
            case 'closed':
                sendButton.disabled = true;
                messageInput.disabled = true;
                updateConnectionStatusUI('disconnected');
                break;
        }
    }
    
    // 连接WebSocket
    function connectWebSocket(roomId) {
        if (isConnecting || !roomId) {
            return;
        }
        
        isConnecting = true;
        updateConnectionStatus('connecting');
        
        // 如果已经超过最大重连次数，显示错误
        if (reconnectAttempts >= maxReconnectAttempts) {
            messageList.innerHTML = `
                <div class="alert alert-danger m-3">
                    <h5><i class="fas fa-exclamation-triangle"></i> 连接失败</h5>
                    <p>无法连接到聊天服务器，请重试。</p>
                    <button class="btn btn-primary" onclick="connectWebSocket(${roomId})">重新连接</button>
                </div>
            `;
            loadingIndicator.style.display = 'none';
            updateConnectionStatus('disconnected');
            isConnecting = false;
            reconnectAttempts = 0;
            return;
        }
        
        const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const host = window.location.host;
        const wsUrl = `${protocol}${host}/ws/chat/${roomId}/`;
        
        try {
            // 关闭任何现有的WebSocket连接
            if (chatSocket) {
                try {
                    chatSocket.close(1000, "重新连接");
                } catch (e) {
                    // 忽略关闭错误
                }
            }
            
            chatSocket = new WebSocket(wsUrl);
            
            // 设置连接超时
            const connectionTimeout = setTimeout(() => {
                if (chatSocket && chatSocket.readyState !== WebSocket.OPEN) {
                    chatSocket.close(4000, "连接超时");
                }
            }, 10000); // 10秒连接超时
            
            chatSocket.onopen = function(e) {
                clearTimeout(connectionTimeout);
                reconnectAttempts = 0; // 重置重连次数
                reconnectInterval = 3000; // 重置重连间隔
                updateConnectionStatus('connected');
                isConnecting = false;
            };
            
            chatSocket.onclose = function(e) {
                updateConnectionStatus('disconnected');
                isConnecting = false;
                
                // 如果是正常关闭或页面刷新，不自动重连
                if (e.code === 1000 || e.code === 1001 || !activeRoomId || activeRoomId !== roomId) {
                    return;
                }
                
                // 非正常关闭时尝试重连
                reconnectAttempts++;
                
                // 使用指数退避策略增加重连间隔
                reconnectInterval = Math.min(reconnectInterval * 1.5, 30000);
                
                showSystemMessage(`连接已断开，${reconnectInterval/1000}秒后重试...`, 'error');
                
                setTimeout(function() {
                    if (activeRoomId === roomId) {
                        connectWebSocket(roomId);
                    }
                }, reconnectInterval);
            };
            
            chatSocket.onerror = function(e) {
                isConnecting = false;
                // WebSocket 错误事件不提供具体错误信息
            };
            
            chatSocket.onmessage = function(e) {
                try {
                    const data = JSON.parse(e.data);
                    
                    if (data.type === 'chat_history') {
                        // 清除加载指示器
                        loadingIndicator.style.display = 'none';
                        
                        if (data.messages.length === 0) {
                            emptyStateElement = document.createElement('div');
                            emptyStateElement.classList.add('text-center', 'my-5');
                            emptyStateElement.innerHTML = `
                                <div class="mb-3">
                                    <i class="fas fa-comments fa-3x text-muted"></i>
                                </div>
                                <h5>暂无消息</h5>
                                <p class="text-muted">发送第一条消息开始对话吧！</p>
                            `;
                            messageList.appendChild(emptyStateElement);
                        } else {
                            data.messages.forEach(function(msg) {
                                addMessage(msg.message, msg.sender_id, msg.sender_name, msg.timestamp, msg.is_read);
                            });
                            
                            // 确保在所有消息加载后滚动到底部
                            scrollToBottom();
                        }
                        
                        // 发送已读标记
                        if (chatSocket.readyState === WebSocket.OPEN) {
                            chatSocket.send(JSON.stringify({
                                'type': 'mark_read'
                            }));
                        }
                        
                    } else if (data.type === 'chat_message') {
                        addMessage(data.message, data.sender_id, data.sender_name, data.timestamp, false);
                        
                        // 如果消息不是自己发送的，则标记为已读
                        if (data.sender_id !== currentUserId && chatSocket.readyState === WebSocket.OPEN) {
                            chatSocket.send(JSON.stringify({
                                'type': 'mark_read'
                            }));
                        }
                    }
                } catch (error) {
                    showSystemMessage('处理消息时出错', 'error');
                }
            };
        } catch(error) {
            updateConnectionStatus('disconnected');
            isConnecting = false;
            reconnectAttempts++;
            showSystemMessage(`连接出错，${reconnectInterval/1000}秒后重试...`, 'error');
            
            setTimeout(function() {
                if (activeRoomId === roomId) {
                    connectWebSocket(roomId);
                }
            }, reconnectInterval);
        }
    }
    
    // 发送消息
    function sendMessage(message) {
        if (!message.trim() || !activeRoomId) return;
        
        if (!chatSocket || chatSocket.readyState !== WebSocket.OPEN) {
            showSystemMessage('无法发送消息，正在尝试重新连接...', 'error');
            connectWebSocket(activeRoomId);
            return;
        }
        
        try {
            chatSocket.send(JSON.stringify({
                'type': 'chat_message',
                'message': message
            }));
            
            messageInput.value = '';
        } catch (error) {
            showSystemMessage('发送消息失败，请重试', 'error');
        }
    }
    
    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
        console.log('页面加载完成，初始化聊天功能');
        
        // 提交表单发送消息
        if (chatForm) {
            chatForm.addEventListener('submit', function(e) {
                e.preventDefault();
                sendMessage(messageInput.value);
            });
        }

        // 按Enter键发送消息
        if (messageInput) {
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage(messageInput.value);
                }
            });
        }
        
        // 修复布局问题
        fixLayoutOnLoad();
        
        // 在移动设备上初始化
        if (isMobileView) {
            // 默认显示聊天列表标签内容
            document.getElementById('tab-chats').click();
            // 确保显示联系人列表，隐藏聊天面板
            showContactList();
        }
    });
    
    // 修复布局问题的函数
    function fixLayoutOnLoad() {
        // 确保联系人列表在移动端正常显示
        if (isMobileView) {
            const sidebar = document.getElementById('chat-sidebar');
            if (sidebar) {
                sidebar.style.width = '100%';
                sidebar.style.margin = '0 auto';
            }
        }
        
        // 检查群组头像是否正常显示
        document.querySelectorAll('.chat-avatar img').forEach(img => {
            img.onerror = function() {
                // 如果图片加载失败，使用默认的UI Avatars
                const altText = this.alt || 'Group';
                this.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(altText)}&size=150&background=3498db&color=fff`;
            };
        });
    }
    
    // 添加开始私聊的函数
    function startPrivateChat(userId) {
        // 禁用点击区域，防止重复点击
        const contactItem = document.querySelector(`.contact-item[data-user-id="${userId}"]`);
        if (contactItem) {
            contactItem.style.pointerEvents = 'none';
            contactItem.style.opacity = '0.7';
        }
        
        // 获取CSRF令牌
        const csrfToken = '{{ csrf_token }}';
        
        // 准备请求数据
        const requestData = {
            user_id: userId
        };
        
        // 发送请求创建私聊
        fetch('{% url "chat:create_private_chat" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(requestData),
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP错误 ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                const roomId = data.room_id;
                
                // 恢复点击区域
                if (contactItem) {
                    contactItem.style.pointerEvents = '';
                    contactItem.style.opacity = '';
                }
                
                // 加载聊天室
                loadChatRoom(roomId);
                
                // 如果聊天室不在列表中，则刷新页面
                if (!document.querySelector(`.room-item[data-room-id="${roomId}"]`)) {
                    window.location.reload();
                }
            } else {
                throw new Error(data.message || '创建聊天失败');
            }
        })
        .catch(error => {
            console.error('创建私聊出错:', error);
            if (contactItem) {
                contactItem.style.pointerEvents = '';
                contactItem.style.opacity = '';
            }
            alert('创建聊天失败: ' + error.message);
        });
    }
    
    // 页面聚焦时标记消息为已读
    window.addEventListener('focus', function() {
        if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({
                'type': 'mark_read'
            }));
        }
    });
    
    // 页面离开前关闭WebSocket连接
    window.addEventListener('beforeunload', function() {
        if (chatSocket) {
            chatSocket.close(1000, '用户离开页面');
        }
    });

    // 执行刷新操作
    function performRefresh() {
        if (isRefreshing || !activeRoomId) return;
        
        isRefreshing = true;
        
        // 更新刷新指示器状态，确保可见
        if (refreshIndicator) {
            refreshIndicator.style.visibility = 'visible';
            refreshIndicator.style.transform = 'translateY(0)';
            const refreshText = refreshIndicator.querySelector('.refresh-text');
            if (refreshText) {
                refreshText.textContent = '刷新中...';
            }
        }
        
        // 重新加载当前聊天记录
        if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({
                'type': 'reload_history'
            }));
            
            // 模拟延迟，给用户视觉反馈
            setTimeout(() => {
                finishRefresh();
            }, 1000);
        } else {
            // 如果WebSocket未连接，尝试重连
            connectWebSocket(activeRoomId);
            setTimeout(() => {
                finishRefresh();
            }, 1500);
        }
    }

    // 修复聊天列表在桌面模式下的显示
    function fixChatListDisplay() {
        // 检查是否是桌面模式
        if (window.innerWidth >= 768) {
            // 在桌面模式下确保所有聊天列表项目都显示
            document.querySelectorAll('.room-item').forEach(item => {
                item.style.display = 'flex';
            });
        }
    }

    // 添加窗口大小变化监听器
    window.addEventListener('resize', function() {
        // 在每次窗口大小变化时检查并修复聊天列表显示
        fixChatListDisplay();
    });
</script>
{% endblock %} 